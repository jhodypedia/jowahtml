<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard WA</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
<style>
  body { background: #f8f9fa; }
  .nav-link { cursor: pointer; }
  .card { box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
  textarea { resize: none; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">WA Dashboard</a>
    <button id="logoutBtn" class="btn btn-outline-light">Logout</button>
  </div>
</nav>

<div class="container mt-4">
  <ul class="nav nav-tabs" id="myTab">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabSend">Kirim Pesan</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMedia">Kirim Media</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#tabBroadcast">Broadcast</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLogs">Logs</a></li>
  </ul>

  <div class="tab-content border p-3 bg-white rounded-bottom">
    <!-- Kirim Pesan -->
    <div class="tab-pane fade show active" id="tabSend">
      <form id="sendMessageForm">
        <div class="mb-3">
          <label>Nomor Tujuan</label>
          <input type="text" id="to" class="form-control" placeholder="Contoh: 08xxxxxx">
        </div>
        <div class="mb-3">
          <label>Pesan</label>
          <textarea id="message" class="form-control" rows="3"></textarea>
        </div>
        <button class="btn btn-primary">Kirim</button>
      </form>
    </div>

    <!-- Kirim Media -->
    <div class="tab-pane fade" id="tabMedia">
      <form id="sendMediaForm" enctype="multipart/form-data">
        <div class="mb-3">
          <label>Nomor Tujuan</label>
          <input type="text" id="mediaTo" class="form-control" placeholder="Contoh: 08xxxxxx">
        </div>
        <div class="mb-3">
          <label>File</label>
          <input type="file" id="mediaFile" class="form-control">
        </div>
        <div class="mb-3">
          <label>Caption</label>
          <input type="text" id="mediaCaption" class="form-control">
        </div>
        <button class="btn btn-success">Kirim Media</button>
      </form>
    </div>

    <!-- Broadcast -->
    <div class="tab-pane fade" id="tabBroadcast">
      <form id="broadcastForm">
        <div class="mb-3">
          <label>Daftar Nomor (pisahkan dengan enter)</label>
          <textarea id="broadcastNumbers" class="form-control" rows="4" placeholder="08xxxxxx&#10;08yyyyyy"></textarea>
        </div>
        <div class="mb-3">
          <label>Pesan</label>
          <textarea id="broadcastMessage" class="form-control" rows="3"></textarea>
        </div>
        <button class="btn btn-warning">Kirim Broadcast</button>
      </form>
      <div class="progress mt-3" style="height: 20px; display:none;">
        <div id="broadcastProgress" class="progress-bar" style="width: 0%">0%</div>
      </div>
    </div>

    <!-- Logs -->
    <div class="tab-pane fade" id="tabLogs">
      <button id="refreshLogs" class="btn btn-outline-primary mb-2">Refresh Logs</button>
      <ul id="messagesList" class="list-group"></ul>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
const API_BASE = "/api";
let token = localStorage.getItem("token");

toastr.options = { closeButton:true, progressBar:true, positionClass:"toast-bottom-right" };

// Logout
$("#logoutBtn").click(() => {
  localStorage.removeItem("token");
  location.href = "index.html";
});

// Kirim Pesan
$("#sendMessageForm").submit(async e => {
  e.preventDefault();
  const number = formatNumber($("#to").val());
  const text = $("#message").val();
  try {
    const res = await fetch(`${API_BASE}/messages/send`, {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Authorization":`Bearer ${token}` },
      body: JSON.stringify({ jid: number+"@s.whatsapp.net", text })
    });
    const data = await res.json();
    if (data.ok) toastr.success("Pesan terkirim");
    else toastr.error(data.message || data.error);
  } catch { toastr.error("Gagal mengirim pesan"); }
});

// Kirim Media
$("#sendMediaForm").submit(async e => {
  e.preventDefault();
  const number = formatNumber($("#mediaTo").val());
  const file = $("#mediaFile")[0].files[0];
  if (!file) return toastr.error("Pilih file terlebih dahulu");
  const formData = new FormData();
  formData.append("file", file);
  formData.append("jid", number+"@s.whatsapp.net");
  formData.append("caption", $("#mediaCaption").val());
  try {
    const res = await fetch(`${API_BASE}/messages/sendmedia`, {
      method:"POST",
      headers:{ "Authorization":`Bearer ${token}` },
      body: formData
    });
    const data = await res.json();
    if (data.ok) toastr.success("Media terkirim");
    else toastr.error(data.message || data.error);
  } catch { toastr.error("Gagal mengirim media"); }
});

// Broadcast
$("#broadcastForm").submit(async e => {
  e.preventDefault();
  const numbers = $("#broadcastNumbers").val().split(/\n|,/).map(n => formatNumber(n.trim())).filter(n => n);
  const text = $("#broadcastMessage").val();
  if (!numbers.length) return toastr.error("Nomor kosong");
  $(".progress").show();
  let sent = 0;
  for (let n of numbers) {
    try {
      const res = await fetch(`${API_BASE}/messages/send`, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization":`Bearer ${token}` },
        body: JSON.stringify({ jid: n+"@s.whatsapp.net", text })
      });
      const data = await res.json();
      if (data.ok) sent++;
    } catch {}
    let percent = Math.round((sent / numbers.length) * 100);
    $("#broadcastProgress").css("width", percent+"%").text(percent+"%");
  }
  toastr.success("Broadcast selesai");
});

// Logs
$("#refreshLogs").click(async () => {
  try {
    const res = await fetch(`${API_BASE}/messages`, {
      headers:{ "Authorization":`Bearer ${token}` }
    });
    const data = await res.json();
    if (data.ok) {
      $("#messagesList").empty();
      data.messages.forEach(m => {
        $("#messagesList").append(`<li class="list-group-item"><strong>${m.jid}:</strong> ${m.text || "[Media]"} <span class="text-muted small">(${m.createdAt})</span></li>`);
      });
    }
  } catch { toastr.error("Gagal memuat logs"); }
});

function formatNumber(num) {
  return num.replace(/\D/g, "").replace(/^0/, "62");
}
</script>
</body>
</html>
