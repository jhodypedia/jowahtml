<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WA REST API — Control Panel</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 16px; }
    .cols { display: flex; gap: 16px; align-items: flex-start; }
    .card { border: 1px solid #e1e4e8; padding: 12px; border-radius: 8px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.03); }
    .card.wide { flex: 1; }
    img.qr { border: 1px solid #ddd; padding: 8px; background: #fafafa; }
    pre.log { height: 320px; overflow: auto; background:#0f1720; color:#d1fae5; padding:8px; border-radius:6px;}
    label { display:block; margin-top:8px; font-weight:600; }
    input[type=text], textarea { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
    button { padding:8px 12px; margin-top:8px; cursor:pointer; }
    .small { font-size:0.9em; color:#555; }
    .row { display:flex; gap:8px; align-items:center; }
    .msgs { max-height:320px; overflow:auto; border:1px solid #eee; padding:8px; border-radius:6px; background:#fbfbfb; }
    .msg-item { border-bottom:1px solid #f0f0f0; padding:6px 0; }
    .status { padding:6px 10px; border-radius:6px; display:inline-block; }
    .status.ok { background:#e6ffed; color:#046c3b; }
    .status.warn { background:#fff7e6; color:#7a4b00; }
  </style>
</head>
<body>
  <h1>WA REST API — Control Panel</h1>
  <p class="small">Ganti <code>API_KEY</code> di bawah sesuai `.env` kamu. Pastikan server berjalan dan CORS mengizinkan origin ini.</p>

  <div class="cols">
    <div class="card" style="width:360px">
      <h3>1) QR Login</h3>
      <div id="qrWrap">
        <img id="qrImg" class="qr" width="300" alt="QR akan muncul di sini" />
        <div id="qrHint" class="small">Menunggu QR...</div>
      </div>
      <div style="margin-top:8px">
        <button id="refreshQrBtn">Refresh QR</button>
        <button id="logoutBtn" style="margin-left:8px">Logout (clear auth)</button>
      </div>

      <hr/>

      <h4>Connection</h4>
      <div id="connState" class="status warn">Not connected</div>
      <div class="small" id="connDetails"></div>
    </div>

    <div class="card wide">
      <h3>2) Send Message</h3>

      <div style="display:flex; gap:12px">
        <div style="flex:1">
          <label>JID (contoh: 628123456789@s.whatsapp.net)</label>
          <input type="text" id="jidInput" placeholder="628...@s.whatsapp.net" />
          <label>Pesan teks</label>
          <textarea id="textInput" rows="3" placeholder="Isi pesan..."></textarea>
          <div class="row">
            <button id="sendTextBtn">Kirim Teks</button>
            <button id="getChatsBtn">Refresh Chats</button>
          </div>
        </div>

        <div style="width:320px">
          <label>Kirim file (image/video/audio/document)</label>
          <input type="file" id="fileInput" />
          <label>Caption (opsional)</label>
          <input type="text" id="captionInput" placeholder="Caption..." />
          <div class="row">
            <button id="sendMediaBtn">Kirim Media</button>
            <span class="small" id="fileInfo"></span>
          </div>
        </div>
      </div>

      <hr/>

      <h4>Chats</h4>
      <div class="msgs" id="chatsList">Belum ada data</div>
    </div>

    <div class="card" style="width:360px">
      <h3>3) Events & Logs</h3>
      <div style="display:flex; gap:8px; align-items:center;">
        <label style="margin:0">API Key</label>
        <input id="apiKeyInput" type="text" value="replace_with_your_api_key" style="flex:1" />
      </div>
      <div style="margin-top:8px">
        <button id="connectEsBtn">Connect SSE</button>
        <button id="disconnectEsBtn" disabled>Disconnect SSE</button>
      </div>

      <h4>Realtime log</h4>
      <pre id="log" class="log">-- logs --</pre>

      <h4>Incoming messages</h4>
      <div id="msgs" class="msgs"></div>
    </div>
  </div>

  <script>
    // CONFIG
    let API_KEY = document.getElementById('apiKeyInput').value.trim(); // user can edit on UI
    const BASE = 'http://151.240.0.221'; // jika backend di origin sama, biarkan ''; atau masukkan full URL mis. 'https://example.com'
    const QR_POLL_INTERVAL = 3000; // ms (fallback)
    const USE_POLL_FOR_QR = false; // kita rely SSE 'qr' event mostly; kalau ingin polling ubah true

    // ELEMENTS
    const qrImg = document.getElementById('qrImg');
    const qrHint = document.getElementById('qrHint');
    const connState = document.getElementById('connState');
    const connDetails = document.getElementById('connDetails');
    const logEl = document.getElementById('log');
    const msgsEl = document.getElementById('msgs');
    const chatsList = document.getElementById('chatsList');
    const apiKeyInput = document.getElementById('apiKeyInput');

    // forms
    const jidInput = document.getElementById('jidInput');
    const textInput = document.getElementById('textInput');
    const sendTextBtn = document.getElementById('sendTextBtn');
    const getChatsBtn = document.getElementById('getChatsBtn');
    const fileInput = document.getElementById('fileInput');
    const sendMediaBtn = document.getElementById('sendMediaBtn');
    const captionInput = document.getElementById('captionInput');
    const fileInfo = document.getElementById('fileInfo');
    const refreshQrBtn = document.getElementById('refreshQrBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const connectEsBtn = document.getElementById('connectEsBtn');
    const disconnectEsBtn = document.getElementById('disconnectEsBtn');

    // state
    let es = null;
    let lastQrDataUrl = null;

    function log(...args) {
      const line = '[' + new Date().toLocaleTimeString() + '] ' + args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
      logEl.textContent = line + '\n' + logEl.textContent;
    }

    // update API_KEY when user edits
    apiKeyInput.addEventListener('change', () => {
      API_KEY = apiKeyInput.value.trim();
      log('API key updated');
    });

    // fetch QR endpoint (fallback)
    async function fetchQrOnce() {
      if (!API_KEY) { log('No API key'); return; }
      try {
        const res = await fetch(BASE + '/auth/qr', {
          headers: { 'x-api-key': API_KEY }
        });
        const j = await res.json();
        if (j.ok && j.qrDataUrl) {
          setQr(j.qrDataUrl);
        } else {
          log('No QR available', j);
          if (j.message) qrHint.textContent = j.message;
        }
      } catch (err) {
        log('fetchQr error', String(err));
      }
    }

    function setQr(dataUrl) {
      if (!dataUrl) {
        qrImg.src = '';
        qrHint.textContent = 'Tidak ada QR (mungkin sudah terhubung)';
        connState.textContent = 'Connected';
        connState.className = 'status ok';
        return;
      }
      lastQrDataUrl = dataUrl;
      qrImg.src = dataUrl;
      qrHint.textContent = 'Scan QR dengan WhatsApp (via ponsel) untuk pairing';
      connState.textContent = 'Awaiting QR';
      connState.className = 'status warn';
      log('QR displayed');
    }

    // SSE (EventSource) connection
    function connectSse() {
      if (!API_KEY) { alert('Masukkan API_KEY di panel kanan'); return; }
      if (es) { log('SSE already connected'); return; }
      // pass api_key as query param because browsers can't set headers on EventSource
      const url = (BASE || '') + '/events?api_key=' + encodeURIComponent(API_KEY);
      es = new EventSource(url);
      log('Connecting SSE to ' + url);

      es.addEventListener('open', () => {
        log('SSE open');
        connectEsBtn.disabled = true;
        disconnectEsBtn.disabled = false;
      });

      es.addEventListener('qr', e => {
        try {
          const data = JSON.parse(e.data);
          if (data.dataUrl) setQr(data.dataUrl);
          log('Event qr', data);
        } catch (err) { log('qr parse err', err); }
      });

      es.addEventListener('connection.update', e => {
        try {
          const data = JSON.parse(e.data);
          log('connection.update', data);
          const conn = data?.connection || data?.connection?.state || JSON.stringify(data);
          const status = data?.connection === 'open' ? 'Connected' : (data?.connection || 'Unknown');
          connState.textContent = status;
          connState.className = (status === 'Connected') ? 'status ok' : 'status warn';
          connDetails.textContent = JSON.stringify(data);
          if (data?.connection === 'open') {
            qrImg.src = '';
            qrHint.textContent = 'Terhubung';
          }
        } catch (err) { log('conn.update parse err', err); }
      });

      es.addEventListener('messages.upsert', e => {
        try {
          const data = JSON.parse(e.data);
          log('messages.upsert', data);
          displayIncoming(data);
        } catch (err) { log('msg parse err', err); }
      });

      es.addEventListener('presence.update', e => {
        log('presence.update', e.data);
      });

      es.addEventListener('error', e => {
        log('SSE error', e);
        // EventSource will auto-retry; we keep connection handle
      });
    }

    function disconnectSse() {
      if (!es) return;
      es.close();
      es = null;
      connectEsBtn.disabled = false;
      disconnectEsBtn.disabled = true;
      log('SSE disconnected');
    }

    connectEsBtn.addEventListener('click', connectSse);
    disconnectEsBtn.addEventListener('click', disconnectSse);

    // send text
    sendTextBtn.addEventListener('click', async () => {
      const jid = jidInput.value.trim();
      const text = textInput.value.trim();
      if (!jid || !text) { alert('JID & text required'); return; }
      try {
        const res = await fetch(BASE + '/messages/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY },
          body: JSON.stringify({ jid, text })
        });
        const j = await res.json();
        log('sendText response', j);
        if (j.ok) { textInput.value = ''; }
      } catch (err) { log('sendText err', String(err)); }
    });

    // send media
    fileInput.addEventListener('change', () => {
      const f = fileInput.files[0];
      if (f) fileInfo.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
      else fileInfo.textContent = '';
    });

    sendMediaBtn.addEventListener('click', async () => {
      const jid = jidInput.value.trim();
      if (!jid) { alert('JID required'); return; }
      const f = fileInput.files[0];
      if (!f) { alert('Pilih file'); return; }
      const caption = captionInput.value || '';
      const form = new FormData();
      form.append('jid', jid);
      form.append('caption', caption);
      form.append('file', f, f.name);

      try {
        const res = await fetch(BASE + '/messages/sendmedia', {
          method: 'POST',
          headers: { 'x-api-key': API_KEY },
          body: form
        });
        const j = await res.json();
        log('sendMedia response', j);
      } catch (err) {
        log('sendMedia error', String(err));
      }
    });

    // refresh qr button (fallback)
    refreshQrBtn.addEventListener('click', fetchQrOnce);

    // logout button
    logoutBtn.addEventListener('click', async () => {
      if (!confirm('Logout dan hapus credential auth?')) return;
      try {
        const res = await fetch(BASE + '/auth/logout', { method: 'POST', headers: { 'x-api-key': API_KEY } });
        const j = await res.json();
        log('logout', j);
      } catch (err) { log('logout err', String(err)); }
    });

    // fetch chats
    getChatsBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(BASE + '/chats', { headers: { 'x-api-key': API_KEY } });
        const j = await res.json();
        log('chats', j);
        if (j.ok && Array.isArray(j.chats)) {
          renderChats(j.chats);
        } else {
          chatsList.textContent = JSON.stringify(j, null, 2);
        }
      } catch (err) { log('getChats err', String(err)); }
    });

    function renderChats(chats) {
      if (!Array.isArray(chats) || chats.length === 0) { chatsList.textContent = 'No chats'; return; }
      chatsList.innerHTML = chats.map(c => {
        let id = c?.id?.id || c?.id || c?.conversation || JSON.stringify(c);
        let name = c?.name || c?.contact?.name || '';
        return `<div><strong>${id}</strong><div class="small">${name}</div></div>`;
      }).join('<hr/>');
    }

    function displayIncoming(data) {
      // messages.upsert payload shape varies — show raw for now
      const div = document.createElement('div');
      div.className = 'msg-item';
      div.textContent = JSON.stringify(data, null, 2);
      msgsEl.prepend(div);
    }

    // auto poll QR when SSE not used
    if (USE_POLL_FOR_QR) {
      setInterval(() => {
        if (!es) fetchQrOnce();
      }, QR_POLL_INTERVAL);
    }

    // on load: prefill API key field with example (user should replace)
    document.addEventListener('DOMContentLoaded', () => {
      // keep API_KEY in sync with field
      API_KEY = apiKeyInput.value.trim();
      log('Panel ready — set API_KEY and press "Connect SSE"');
    });
  </script>
</body>
</html>
