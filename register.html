<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - WhatsApp API</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #0d6efd, #6610f2);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-5">
      <div class="card p-4 animate__animated animate__fadeInUp">
        <h3 class="text-center mb-3">Daftar Akun</h3>
        <form id="registerForm">
          <div class="mb-3">
            <label>Username</label>
            <input type="text" id="username" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Email</label>
            <input type="email" id="email" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Password</label>
            <input type="password" id="password" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Nomor WhatsApp</label>
            <input type="text" id="phone" class="form-control" placeholder="08xxxxxxxxxx" required>
          </div>
          <button class="btn btn-primary w-100">Daftar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal OTP -->
<div class="modal fade" id="otpModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="mb-3">Verifikasi OTP</h5>
      <form id="otpForm">
        <div class="mb-3">
          <label>Kode OTP</label>
          <input type="text" id="otpCode" class="form-control" placeholder="Masukkan kode OTP" required>
        </div>
        <button class="btn btn-success w-100">Verifikasi</button>
      </form>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
const API_BASE = "/api"; // Sudah diarahkan ke VPS lewat vercel.json
let registeredPhone = "";

// Toastr config
toastr.options = {
  closeButton: true,
  progressBar: true,
  positionClass: "toast-bottom-right",
  timeOut: 3000
};

// Register submit
$("#registerForm").on("submit", async function(e){
  e.preventDefault();
  let username = $("#username").val();
  let email = $("#email").val();
  let password = $("#password").val();
  let phone = $("#phone").val();

  // Ubah 08xxxx â†’ 62xxxx
  if(phone.startsWith("0")) {
    phone = "62" + phone.substring(1);
  }

  try {
    let res = await fetch(`${API_BASE}/auth/register`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ username, email, password, phone })
    });
    let data = await res.json();
    if(res.ok && data.ok) {
      toastr.success("Registrasi berhasil, OTP dikirim ke WhatsApp");
      registeredPhone = phone;
      new bootstrap.Modal(document.getElementById("otpModal")).show();
    } else {
      toastr.error(data.message || "Gagal registrasi");
    }
  } catch(err) {
    toastr.error("Gagal konek ke server");
  }
});

// OTP submit
$("#otpForm").on("submit", async function(e){
  e.preventDefault();
  let otp = $("#otpCode").val();
  try {
    let res = await fetch(`${API_BASE}/auth/verify-otp`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ phone: registeredPhone, otp })
    });
    let data = await res.json();
    if(res.ok && data.ok) {
      toastr.success("Verifikasi OTP berhasil!");
      setTimeout(() => window.location = "login.html", 1000);
    } else {
      toastr.error(data.message || "OTP salah");
    }
  } catch(err) {
    toastr.error("Gagal verifikasi OTP");
  }
});
</script>

</body>
</html>
